<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visor 360 de Real Estate (A-Frame)</title>
    <!-- Incluye el SDK de A-Frame (basado en Three.js) -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <!-- Incluye Tailwind CSS para la interfaz de usuario 2D -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos básicos para asegurar que el canvas ocupe toda la pantalla y el cuerpo sin márgenes */
        body { margin: 0; overflow: hidden; font-family: 'Inter', sans-serif; }
        /* Aseguramos que la escena A-Frame siempre tome el 100% */
        a-scene { height: 100vh; width: 100vw; }
        
        /* La capa de UI flotará sobre la escena VR */
        #ui-overlay {
            z-index: 10;
            pointer-events: auto; /* Permite la interacción con los elementos del overlay */
            background-color: rgba(0, 0, 0, 0.7);
            max-height: 100vh;
            overflow-y: auto;
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
        /* Clase para ocultar el panel UI */
        #ui-overlay.hidden {
            transform: translateX(-100%);
            opacity: 0;
            pointer-events: none;
        }
        
        /* Contenedor de Botones Flotantes */
        #floating-buttons {
            z-index: 11;
            bottom: 1rem;
            left: 1rem;
            position: fixed; /* Usar fixed en lugar de absolute para mantener la posición */
            display: flex;
            flex-direction: column;
            gap: 12px; /* Espacio entre botones */
        }

        /* Estilos para las modales del visor de URL */
        #content-modal, #url-input-modal {
            background-color: rgba(0, 0, 0, 0.7);
        }
        
        /* Asegurar que el iframe ocupe todo el espacio disponible */
        #immersive-viewer {
            width: 100%;
            height: 100%;
            border-radius: 0.5rem; /* rounded-lg */
        }
    </style>
</head>
<body>

    <!--
    ======================================================================
    INICIO: INTERFAZ DE USUARIO 2D (Panel de Control y CRUD)
    ======================================================================
    -->
    <div id="ui-overlay" class="absolute top-0 left-0 w-full md:w-auto md:max-w-md mx-auto md:m-4 p-4 rounded-lg shadow-2xl flex flex-col gap-4 text-white">
        <h1 class="text-2xl font-extrabold text-center text-blue-300">Inmobiliaria VR - Control</h1>
        <p id="auth-status" class="text-xs text-yellow-300 text-center"></p>

        <!-- Sección de Carga de Propiedad -->
        <div class="border-b border-gray-600 pb-3">
            <h2 class="text-lg font-semibold mb-2">1. Visualizar Propiedad Actual</h2>
            <div class="flex flex-col gap-2">
                <p id="property-title" class="text-xl font-bold text-green-400">Sin Propiedad Cargada</p>
                <p id="property-description" class="text-sm text-gray-300">Utilice la lista o ingrese un código para cargar una propiedad.</p>
            </div>
        </div>

        <!-- Sección de CRUD: Agregar Códigos -->
        <div class="border-b border-gray-600 pb-3">
            <h2 class="text-lg font-semibold mb-2">2. Añadir/Guardar Códigos</h2>
            <div class="flex flex-col sm:flex-row gap-2">
                <input type="text" id="code-input" placeholder="Ej: PR001, PR002, PR003"
                       class="flex-grow p-2 rounded-lg border border-gray-600 bg-gray-700 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button id="add-code-button" onclick="addCodes()"
                        class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 shadow-md flex-shrink-0">
                    Guardar Códigos
                </button>
            </div>
            <p id="crud-message" class="text-xs mt-1 text-gray-400 italic">Separe múltiples códigos con comas (Ej: A1, B2, C3).</p>
        </div>

        <!-- Sección de CRUD: Lista de Códigos Guardados -->
        <div>
            <h2 class="text-lg font-semibold mb-2">3. Mis Códigos Guardados</h2>
            <ul id="saved-codes-list" class="space-y-2">
                <!-- Los códigos se insertarán aquí dinámicamente -->
                <li class="text-center text-gray-400">Cargando lista...</li>
            </ul>
        </div>
    </div>
    
    <!-- Contenedor de Botones Flotantes -->
    <div id="floating-buttons">
        
        <!-- Botón 1: Alternar la visibilidad de la interfaz (Ojo) -->
        <button id="toggle-button" onclick="toggleUI()"
                class="bg-gray-800 hover:bg-gray-700 text-white p-3 rounded-full shadow-lg transition duration-200">
            <!-- Icono de ojo abierto (predeterminado) -->
            <svg id="eye-open" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
            </svg>
            <!-- Icono de ojo cerrado (oculto por defecto) -->
            <svg id="eye-closed" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7 1.274-4.057 5.064-7 9.542-7 1.763 0 3.497.411 5.035 1.157"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.08 11.233A10.05 10.05 0 0122 12c-1.274 4.057-5.064 7-9.542 7-1.763 0-3.497-.411-5.035-1.157M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
        </button>

        <!-- Botón 2: Abrir la Modal de URL (Flotante) - NUEVO -->
        <button id="open-url-modal-btn" 
                class="flex items-center justify-center w-12 h-12 bg-blue-600 text-white rounded-full shadow-xl hover:bg-blue-700 transition duration-300 transform hover:scale-105" 
                title="Cargar Contenido Inmersivo (360/3D)">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                <path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25ZM12.75 9a.75.75 0 0 0-1.5 0v2.25H9a.75.75 0 0 0 0 1.5h2.25V15a.75.75 0 0 0 1.5 0v-2.25H15a.75.75 0 0 0 0-1.5h-2.25V9Z" clip-rule="evenodd" />
            </svg>
        </button>
    </div>
    

    <!--
    ======================================================================
    INICIO: ESCENA A-FRAME (VR)
    ======================================================================
    -->
    <a-scene embedded vr-mode-ui="enabled: true" device-orientation-permission-ui="enabled: false">

        <!-- Assets Manager: Pre-carga los assets para evitar parpadeos -->
        <a-assets>
            <img id="placeholder-img" src="https://placehold.co/4096x2048/34495E/FFFFFF/png?text=VR+LISTO+%7C+CARGUE+UNA+PROPIEDAD" alt="Imagen de bienvenida" crossorigin="anonymous">
            <video id="property-video" src="" crossorigin="anonymous"></video>
        </a-assets>

        <!-- 1. Entorno 360 (Sky) - Inicialmente con el placeholder -->
        <a-sky id="sky360" src="#placeholder-img" rotation="0 -70 0"></a-sky>

        <!-- 2. Contenedor para Modelo 3D (GLTF) -->
        <a-entity id="model-container" visible="false">
            <!-- El modelo 3D se añadirá aquí -->
        </a-entity>

        <!-- 3. Contenedor para Hotspots de Información y Navegación -->
        <a-entity id="hotspot-container"></a-entity>

        <!-- 4. Cámara y Cursor -->
        <a-entity camera look-controls position="0 1.6 0">
            <!-- Cursor: Permite la interacción en VR (mirar para seleccionar) -->
            <a-entity cursor="fuse: true; fuseTimeout: 1000"
                      position="0 0 -1"
                      geometry="primitive: ring; radiusInner: 0.01; radiusOuter: 0.02"
                      material="color: #4CAF50; shader: flat"
                      animation__fusing="property: scale; from: 1 1 1; to: 0.2 0.2 0.2; startEvents: fusing; dur: 1000"
                      animation__fused="property: scale; to: 1 1 1; startEvents: click, fuse-timeout; dur: 150">
            </a-entity>
        </a-entity>

    </a-scene>

    <!--
    ======================================================================
    MODALES PARA VISOR DE URL (NUEVO)
    ======================================================================
    -->
    <!-- Modal 1: Ingreso de URL (Hidden by default) -->
    <dialog id="url-input-modal" class="fixed inset-0 w-full h-full p-4 flex items-center justify-center bg-transparent backdrop:bg-black/70 rounded-xl" style="display: none;">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-lg transform transition-all duration-300 scale-100">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">Cargar Contenido Inmersivo</h2>
            <form id="url-form">
                <div class="mb-4">
                    <label for="immersive-url" class="block text-sm font-medium text-gray-700 mb-2">URL de la Foto/Video 360 o Modelo 3D:</label>
                    <input type="url" id="immersive-url" required placeholder="https://ejemplo.com/visor-360"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="close-url-modal-btn" class="px-4 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 transition duration-150">
                        Cancelar
                    </button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition duration-150 shadow-md">
                        Visualizar
                    </button>
                </div>
            </form>
            <!-- Contenedor para mensajes de error o información -->
            <p id="url-message" class="mt-4 text-sm text-red-500 hidden"></p>
        </div>
    </dialog>

    <!-- Modal 2: Visor de Contenido (Hidden by default) -->
    <dialog id="content-modal" class="fixed inset-0 w-full h-full p-4 flex items-center justify-center bg-transparent backdrop:bg-black/70" style="display: none;">
        <div class="bg-white p-2 rounded-xl shadow-2xl w-full h-full max-w-6xl max-h-[90vh] flex flex-col">
            <!-- Encabezado con título y botón de cierre -->
            <div class="flex justify-between items-center p-3 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-800">Visor de Contenido Inmersivo</h3>
                <button id="close-content-modal-btn" class="p-2 text-gray-500 hover:text-gray-900 rounded-full hover:bg-gray-100 transition duration-150" title="Cerrar Visor">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <!-- Contenedor del Iframe -->
            <div class="flex-grow p-4">
                <iframe id="immersive-viewer" src="" allow="fullscreen; vr; accelerometer; gyroscope; magnetometer;" sandbox="allow-scripts allow-same-origin allow-popups allow-forms allow-pointer-lock" loading="lazy">
                    Tu navegador no soporta iframes.
                </iframe>
            </div>

            <!-- Información sobre la URL cargada -->
            <div class="p-3 border-t border-gray-200 text-sm text-gray-600 truncate">
                URL cargada: <span id="loaded-url-display" class="font-mono text-gray-800"></span>
            </div>
        </div>
    </dialog>


    <!--
    ======================================================================
    INICIO: LÓGICA JAVASCRIPT Y FIREBASE
    ======================================================================
    -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, setDoc, doc, updateDoc, deleteDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variables globales proporcionadas por el entorno
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let userId = 'loading'; // Estado inicial
        let isAuthReady = false;

        // Elementos del DOM para la UI del Panel/A-Frame
        const authStatus = document.getElementById('auth-status');
        const codeInput = document.getElementById('code-input');
        const propertyTitle = document.getElementById('property-title');
        const propertyDescription = document.getElementById('property-description');
        const sky360 = document.getElementById('sky360');
        const modelContainer = document.getElementById('model-container');
        const hotspotContainer = document.getElementById('hotspot-container');
        const savedCodesList = document.getElementById('saved-codes-list');
        const crudMessage = document.getElementById('crud-message');
        const uiOverlay = document.getElementById('ui-overlay');
        const eyeOpenIcon = document.getElementById('eye-open');
        const eyeClosedIcon = document.getElementById('eye-closed');
        
        // Elementos del DOM para el Visor de URL (NUEVO)
        const openUrlModalBtn = document.getElementById('open-url-modal-btn');
        const closeUrlModalBtn = document.getElementById('close-url-modal-btn');
        const urlInputModal = document.getElementById('url-input-modal');
        const urlForm = document.getElementById('url-form');
        const urlInput = document.getElementById('immersive-url');
        const urlMessage = document.getElementById('url-message');
        const contentModal = document.getElementById('content-modal');
        const closeContentModalBtn = document.getElementById('close-content-modal-btn');
        const immersiveViewer = document.getElementById('immersive-viewer');
        const loadedUrlDisplay = document.getElementById('loaded-url-display');


        // Rutas de las colecciones
        const PROPERTIES_COLLECTION_PATH = `/artifacts/${appId}/public/data/properties`;
        let USER_SAVED_PROPERTIES_PATH = ''; // Se define tras la autenticación

        // --- MOCKS DE PROPIEDADES (Datos públicos que la app lee) ---
        const MOCK_PROPERTIES = [
            {
                code: "PR001",
                title: "Foto 360 - Sala Principal (Interactiva)",
                description: "Una vista panorámica de un lujoso apartamento moderno. Contiene hotspots de Info y de Navegación.",
                mediaType: "image360",
                mediaUrl: "https://placehold.co/4096x2048/FF5733/FFFFFF/png?text=IMAGEN+360+SALA",
                // Datos de Hotspots con Información Flotante
                hotspots: [
                    {
                        id: "info-hspot-1",
                        position: "3 1.5 -5", // Posición en el espacio 3D (x y z)
                        infoText: "Sofa de diseño italiano.\n100% piel genuina."
                    },
                    {
                        id: "info-hspot-2",
                        position: "-5 1 0",
                        infoText: "Ventanal de piso a techo.\nFiltro UV/IR incorporado."
                    },
                    {
                        id: "info-hspot-3",
                        position: "0 2.5 4",
                        infoText: "Lámpara colgante exclusiva.\nMaterial: Latón pulido."
                    }
                ],
                // Hotspots de Teletransporte (Navegación)
                teleports: [
                    {
                        id: "tele-hspot-to-kitchen",
                        position: "5 1.6 3",
                        targetCode: "PR004", // Código de la cocina
                        label: "Ir a la Cocina (PR004)"
                    }
                ]
            },
            {
                code: "PR002",
                title: "Video 360 - Recorrido Exterior",
                description: "Tour en video 360 por el jardín y piscina (PR002).",
                mediaType: "video360",
                mediaUrl: "https://commondatabase.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4"
            },
            {
                code: "PR003",
                title: "Plano 3D - Casa Mod. B",
                description: "Modelo 3D GLTF del plano arquitectónico (PR003).",
                mediaType: "gltf3d",
                mediaUrl: "https://cdn.glitch.com/2b39504a-4e2b-42be-8998-386d38e6e58f%2FDuck.glb?v=1560613291079"
            },
            {
                code: "PR004",
                title: "Foto 360 - Cocina (Interactiva)",
                description: "Una cocina moderna y funcional. Permite volver a la sala.",
                mediaType: "image360",
                mediaUrl: "https://placehold.co/4096x2048/3498DB/FFFFFF/png?text=IMAGEN+360+COCINA",
                teleports: [
                    {
                        id: "tele-hspot-to-sala",
                        position: "-5 1.6 -3",
                        targetCode: "PR001", // Código de la sala
                        label: "Volver a la Sala (PR001)"
                    }
                ]
            },
            {
                code: "PR005",
                title: "Foto 360 - Dormitorio Principal",
                description: "El amplio dormitorio con vestidor y baño privado.",
                mediaType: "image360",
                mediaUrl: "https://placehold.co/4096x2048/9B59B6/FFFFFF/png?text=IMAGEN+360+DORMITORIO",
            }
        ];

        // =====================================================================
        // AFRAME CUSTOM COMPONENTS (Se mantienen para cargar propiedades)
        // =====================================================================

        /**
         * Componente 'hotspot-info'
         * Crea y maneja la interacción (mostrar/ocultar) de un Infobox 3D asociado.
         */
        AFRAME.registerComponent('hotspot-info', {
            schema: {
                infoText: {type: 'string', default: 'Información Detallada'},
                infoPosition: {type: 'string', default: '0 0.5 0'}, // Posición relativa del infobox
            },

            init: function () {
                const el = this.el;
                const data = this.data;

                // 1. Crear el Infobox (Texto y Plano de fondo)
                this.infobox = document.createElement('a-entity');
                this.infobox.setAttribute('position', data.infoPosition);
                this.infobox.setAttribute('scale', '0 0 0'); // Inicialmente oculto

                // Geometría y material del fondo del Infobox
                this.infobox.setAttribute('geometry', 'primitive: plane; width: 1.8; height: 0.6');
                this.infobox.setAttribute('material', 'color: #333; opacity: 0.8; shader: flat');
                
                // Texto del Infobox. Reemplazamos \n por saltos de línea reales.
                this.infobox.setAttribute('text', {
                    value: data.infoText.replace(/\\n/g, '\n'), 
                    align: 'center',
                    wrapCount: 30,
                    color: '#FFFFFF'
                });
                
                el.appendChild(this.infobox);

                // 2. Manejo de la Interacción (Hover / Gaze)
                el.addEventListener('mouseenter', () => {
                    el.setAttribute('material', 'color', '#FFC107'); // Hotspot color: amarillo al mirar
                    this.infobox.setAttribute('animation__scale', {
                        property: 'scale',
                        to: '1 1 1',
                        dur: 200,
                        easing: 'easeOutElastic',
                        startEvents: 'mouseenter'
                    });
                });

                el.addEventListener('mouseleave', () => {
                    el.setAttribute('material', 'color', '#4CAF50'); // Hotspot color: verde normal
                    this.infobox.setAttribute('animation__scale', {
                        property: 'scale',
                        to: '0 0 0',
                        dur: 150,
                        easing: 'easeInQuad',
                        startEvents: 'mouseleave'
                    });
                });
            },

            /**
             * Asegura que el Infobox siempre mire a la cámara (función de 'look-at').
             */
            tick: function () {
                if (this.infobox) {
                    const camera = document.querySelector('a-entity[camera]');
                    if (camera) {
                        const cameraWorldPosition = camera.object3D.position.clone();
                        this.infobox.object3D.lookAt(cameraWorldPosition);
                    }
                }
            }
        });
        
        /**
         * Componente 'hotspot-teleport'
         * Permite la navegación entre diferentes propiedades/panoramas.
         */
        AFRAME.registerComponent('hotspot-teleport', {
            schema: {
                targetCode: {type: 'string'},
                label: {type: 'string', default: 'Siguiente Sala'}
            },

            init: function () {
                const el = this.el;
                const data = this.data;

                // 1. Crear el Label (Texto)
                this.labelEl = document.createElement('a-text');
                this.labelEl.setAttribute('value', data.label);
                this.labelEl.setAttribute('position', '0 0.5 0'); // Posición relativa
                this.labelEl.setAttribute('align', 'center');
                this.labelEl.setAttribute('color', '#FFFFFF');
                this.labelEl.setAttribute('wrap-count', 30);
                this.labelEl.setAttribute('scale', '0 0 0'); // Inicialmente oculto

                el.appendChild(this.labelEl);

                // 2. Manejo de la Interacción (Hover / Gaze)
                el.addEventListener('mouseenter', () => {
                    el.setAttribute('material', 'color', '#388E3C'); // Color verde oscuro al mirar
                    this.labelEl.setAttribute('animation__scale', {
                        property: 'scale',
                        to: '1 1 1',
                        dur: 150,
                        easing: 'easeOutQuad',
                        startEvents: 'mouseenter'
                    });
                });

                el.addEventListener('mouseleave', () => {
                    el.setAttribute('material', 'color', '#66BB6A'); // Color verde claro normal
                    this.labelEl.setAttribute('animation__scale', {
                        property: 'scale',
                        to: '0 0 0',
                        dur: 100,
                        easing: 'easeInQuad',
                        startEvents: 'mouseleave'
                    });
                });

                // 3. Manejo del Click (Teletransporte)
                el.addEventListener('click', () => {
                    if (window.loadProperty) {
                        // Muestra un mensaje temporal antes de cargar
                        const msg = document.getElementById('crud-message');
                        msg.textContent = `Navegando a ${data.targetCode}...`;
                        msg.classList.remove('text-red-400', 'text-green-400', 'text-yellow-400');
                        msg.classList.add('text-blue-400');
                        
                        // Carga la nueva propiedad (esto también actualizará el mensaje)
                        window.loadProperty(data.targetCode);
                    }
                });
            },
            
            /**
             * Asegura que el texto del hotspot de teletransporte siempre mire a la cámara.
             */
            tick: function () {
                if (this.labelEl) {
                    const camera = document.querySelector('a-entity[camera]');
                    if (camera) {
                        const cameraWorldPosition = camera.object3D.position.clone();
                        this.labelEl.object3D.lookAt(cameraWorldPosition);
                    }
                }
            }
        });


        // =====================================================================
        // FIREBASE & APP LOGIC (Panel de Control y A-Frame)
        // =====================================================================

        /**
         * Inicializa Firebase, autentica al usuario y establece el listener de autenticación.
         */
        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                authStatus.textContent = 'Autenticando...';

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        authStatus.textContent = `Usuario: ${userId.substring(0, 8)}... (VR)`;
                        
                        USER_SAVED_PROPERTIES_PATH = `/artifacts/${appId}/users/${userId}/userSavedProperties`;

                        // 1. Asegurar la existencia de los datos de prueba públicos
                        initializeMockProperties();

                        // 2. Iniciar la escucha de la lista de códigos guardados del usuario
                        setupSavedCodesListener();

                        // 3. Cargar la última propiedad actual (si existe)
                        loadCurrentProperty();

                    } else {
                        authStatus.textContent = 'No autenticado (sesión anónima)';
                    }
                });

                // Exportar funciones CRUD y UI al ámbito global
                window.addCodes = addCodes;
                window.loadProperty = loadProperty;
                window.deleteSavedCode = deleteSavedCode;
                window.toggleUI = toggleUI; // Exportar función de alternancia

            } catch (error) {
                console.error("Error al inicializar Firebase o autenticar:", error);
                authStatus.textContent = 'Error de Firebase. Consulte la consola.';
            }
        }

        /**
         * Función para alternar la visibilidad de la interfaz de control.
         */
        function toggleUI() {
            const isHidden = uiOverlay.classList.toggle('hidden');
            
            // Alternar los iconos del botón
            eyeOpenIcon.classList.toggle('hidden', isHidden);
            eyeClosedIcon.classList.toggle('hidden', !isHidden);
        }

        /**
         * Inicializa los datos de prueba (MOCKS) en la colección pública.
         */
        async function initializeMockProperties() {
            try {
                const propertiesRef = collection(db, PROPERTIES_COLLECTION_PATH);
                
                console.log("Insertando o actualizando datos Mock de propiedades...");
                // Usamos setDoc con { merge: true } para crear/actualizar todos los mocks
                for (const prop of MOCK_PROPERTIES) {
                    await setDoc(doc(propertiesRef, prop.code), prop, { merge: true });
                }
                console.log("Datos Mock insertados/actualizados con éxito.");

            } catch (error) {
                console.error("Error al inicializar datos Mock:", error);
            }
        }

        /**
         * Intenta cargar la propiedad marcada como 'current' por el usuario.
         */
        async function loadCurrentProperty() {
            if (!isAuthReady || userId === 'loading') return;

            try {
                const userDocRef = doc(db, `/artifacts/${appId}/users/${userId}/currentStatus/config`);
                const docSnap = await getDoc(userDocRef);

                if (docSnap.exists() && docSnap.data().currentCode) {
                    const code = docSnap.data().currentCode;
                    loadProperty(code);
                } else {
                    // Cargar el mock por defecto si no hay nada marcado como actual
                    loadProperty(MOCK_PROPERTIES[0].code);
                }
            } catch (error) {
                console.warn("No se pudo cargar la propiedad actual del usuario:", error);
                loadProperty(MOCK_PROPERTIES[0].code); // Fallback al PR001
            }
        }
        
        /**
         * Guarda una lista de códigos de propiedad ingresados por el usuario.
         */
        async function addCodes() {
            if (!isAuthReady) return;
            const input = codeInput.value.trim();
            if (!input) return;

            // Divide la entrada por comas, filtra vacíos y convierte a mayúsculas
            const newCodes = input.split(',')
                                  .map(c => c.trim().toUpperCase())
                                  .filter(c => c.length > 0);

            if (newCodes.length === 0) return;

            try {
                const savedRef = collection(db, USER_SAVED_PROPERTIES_PATH);
                let codesAdded = 0;

                for (const code of newCodes) {
                    // Usamos el código como ID del documento
                    const docRef = doc(savedRef, code);
                    await setDoc(docRef, { code: code, createdAt: new Date().toISOString() }, { merge: true });
                    codesAdded++;
                }

                crudMessage.textContent = `Se agregaron ${codesAdded} códigos a tu lista.`;
                crudMessage.classList.remove('text-red-400');
                crudMessage.classList.add('text-green-400');
                codeInput.value = '';

            } catch (error) {
                console.error("Error al agregar códigos:", error);
                crudMessage.textContent = `Error al guardar: ${error.message}`;
                crudMessage.classList.remove('text-green-400');
                crudMessage.classList.add('text-red-400');
            }
        }

        /**
         * Elimina un código de la lista guardada del usuario.
         * @param {string} code - El código de propiedad a eliminar.
         */
        async function deleteSavedCode(code) {
            if (!isAuthReady) return;
            try {
                const docRef = doc(db, USER_SAVED_PROPERTIES_PATH, code);
                await deleteDoc(docRef);
                crudMessage.textContent = `Código ${code} eliminado.`;
                crudMessage.classList.remove('text-red-400');
                crudMessage.classList.add('text-green-400');
            } catch (error) {
                console.error(`Error al eliminar código ${code}:`, error);
                crudMessage.textContent = `Error al eliminar ${code}: ${error.message}`;
                crudMessage.classList.remove('text-green-400');
                crudMessage.classList.add('text-red-400');
            }
        }

        /**
         * Marca un código como la propiedad actual del usuario (para la próxima carga).
         * @param {string} code - El código de propiedad a establecer como actual.
         */
        async function setCurrentProperty(code) {
            if (!isAuthReady) return;
            try {
                const docRef = doc(db, `/artifacts/${appId}/users/${userId}/currentStatus/config`);
                await setDoc(docRef, { currentCode: code, updatedAt: new Date().toISOString() }, { merge: true });
                loadProperty(code);
                crudMessage.textContent = `Propiedad actual establecida en ${code}.`;
                crudMessage.classList.remove('text-red-400');
                crudMessage.classList.add('text-blue-400');
            } catch (error) {
                console.error(`Error al establecer propiedad actual ${code}:`, error);
                crudMessage.textContent = `Error al establecer ${code}: ${error.message}`;
                crudMessage.classList.remove('text-blue-400');
                crudMessage.classList.add('text-red-400');
            }
        }
        window.setCurrentProperty = setCurrentProperty; // Exportar para uso en el DOM


        /**
         * Renderiza la lista de códigos guardados del usuario.
         * @param {Array<Object>} codes - Lista de documentos de códigos guardados.
         */
        function renderSavedCodes(codes) {
            savedCodesList.innerHTML = ''; // Limpiar lista
            if (codes.length === 0) {
                savedCodesList.innerHTML = '<li class="text-center text-gray-400 p-2">No tienes códigos guardados. Añade uno.</li>';
                return;
            }

            codes.forEach(savedCode => {
                const listItem = document.createElement('li');
                listItem.className = 'flex flex-wrap items-center justify-between p-3 bg-gray-800 rounded-lg shadow-inner';
                listItem.innerHTML = `
                    <span class="font-bold text-lg text-yellow-300 w-full sm:w-1/3 mb-2 sm:mb-0">${savedCode.code}</span>
                    <div class="flex flex-wrap gap-2 w-full sm:w-2/3 justify-end">
                        <button onclick="loadProperty('${savedCode.code}')" class="text-xs bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded transition duration-150">
                            Cargar VR
                        </button>
                        <button onclick="setCurrentProperty('${savedCode.code}')" class="text-xs bg-indigo-500 hover:bg-indigo-600 text-white px-3 py-1 rounded transition duration-150">
                            Establecer Actual
                        </button>
                        <button onclick="deleteSavedCode('${savedCode.code}')" class="text-xs bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded transition duration-150">
                            Eliminar
                        </button>
                    </div>
                `;
                savedCodesList.appendChild(listItem);
            });
        }


        /**
         * Configura el listener de Firestore para la lista de códigos del usuario.
         */
        function setupSavedCodesListener() {
            if (!isAuthReady || userId === 'loading') return;

            const savedRef = collection(db, USER_SAVED_PROPERTIES_PATH);
            
            onSnapshot(savedRef, (snapshot) => {
                const savedCodes = snapshot.docs.map(doc => doc.data());
                renderSavedCodes(savedCodes.sort((a, b) => a.code.localeCompare(b.code)));
            }, (error) => {
                console.error("Error al escuchar los códigos guardados:", error);
                savedCodesList.innerHTML = '<li class="text-center text-red-400 p-2">Error al cargar la lista.</li>';
            });
        }


        /**
         * Carga la propiedad en la escena VR basándose en el código.
         * @param {string} code - Código de la propiedad a cargar.
         */
        async function loadProperty(code) {
            if (!db) return; 

            code = code.trim().toUpperCase();
            if (!code) return;

            propertyTitle.textContent = `Cargando ${code}...`;
            propertyDescription.textContent = '';
            propertyTitle.classList.remove('text-red-400', 'text-green-400', 'text-blue-400');
            propertyTitle.classList.add('text-yellow-400');

            try {
                // 1. Consulta a Firestore por el código de la propiedad en la colección pública de PROPERTIES
                const propertiesRef = collection(db, PROPERTIES_COLLECTION_PATH);
                const docRef = doc(propertiesRef, code);
                const docSnap = await getDoc(docRef);

                if (!docSnap.exists()) {
                    throw new Error(`Propiedad no encontrada con el código: ${code}. Verifique en la colección pública.`);
                }

                const property = docSnap.data();
                const { title, description, mediaType, mediaUrl } = property;

                // 2. Limpiar escena actual
                sky360.setAttribute('visible', false);
                modelContainer.setAttribute('visible', false);
                while (modelContainer.firstChild) {
                    modelContainer.removeChild(modelContainer.firstChild);
                }
                // Limpiar hotspots
                while (hotspotContainer.firstChild) {
                    hotspotContainer.removeChild(hotspotContainer.firstChild);
                }


                // 3. Cargar el nuevo medio según el tipo
                propertyTitle.textContent = `${title} (${code})`;
                propertyDescription.textContent = description;
                propertyTitle.classList.remove('text-yellow-400', 'text-red-400', 'text-blue-400');
                propertyTitle.classList.add('text-green-400');

                if (mediaType === 'image360' || mediaType === 'video360') {
                    // Carga para FOTO o VIDEO 360 (usa <a-sky>)
                    sky360.setAttribute('visible', true);

                    if (mediaType === 'image360') {
                        // Forzar el recargado del sky
                        sky360.setAttribute('src', '');
                        sky360.setAttribute('src', mediaUrl);
                        sky360.removeAttribute('material', 'src', '#property-video');
                        console.log(`Cargada imagen 360: ${mediaUrl}`);

                    } else if (mediaType === 'video360') {
                        // Creamos o actualizamos el elemento de video en los assets
                        let videoAsset = document.getElementById('property-video');
                        videoAsset.setAttribute('src', mediaUrl);

                        // Es necesario esperar la carga del video
                        videoAsset.load();
                        await new Promise(resolve => videoAsset.onloadedmetadata = resolve);

                        // Configuramos el sky para usar el video y lo reproducimos
                        sky360.setAttribute('src', '#property-video');
                        sky360.setAttribute('material', 'shader: flat; side: back;');
                        videoAsset.play();
                        console.log(`Cargado video 360: ${mediaUrl}`);
                    }
                    
                    // 4. Cargar Hotspots de Información (Info Hotspots)
                    if (property.hotspots && property.hotspots.length > 0) {
                        property.hotspots.forEach(hspot => {
                            // Hotspot (Sphere)
                            const hotspotEl = document.createElement('a-sphere');
                            hotspotEl.setAttribute('id', hspot.id);
                            hotspotEl.setAttribute('radius', '0.15'); // Tamaño ajustado para info
                            hotspotEl.setAttribute('position', hspot.position);
                            // Color verde normal para información
                            hotspotEl.setAttribute('material', 'color: #4CAF50; opacity: 0.8; shader: flat'); 
                            hotspotEl.setAttribute('hotspot-info', 
                                `infoText: ${hspot.infoText.replace(/\n/g, '\\n')}`
                            );
                            hotspotEl.setAttribute('scale', '1 1 1');

                            hotspotContainer.appendChild(hotspotEl);
                        });
                        console.log(`Cargados ${property.hotspots.length} hotspots interactivos.`);
                    }

                    // 5. Cargar Hotspots de Teletransporte (Teleport Hotspots)
                    if (property.teleports && property.teleports.length > 0) {
                        property.teleports.forEach(teleport => {
                            // Hotspot (Sphere para Teletransporte)
                            const teleportEl = document.createElement('a-sphere');
                            teleportEl.setAttribute('id', teleport.id);
                            teleportEl.setAttribute('radius', '0.2'); // Un poco más grande para navegación
                            teleportEl.setAttribute('position', teleport.position);
                            // Color verde claro distintivo para navegación
                            teleportEl.setAttribute('material', 'color: #66BB6A; opacity: 0.9; shader: flat'); 
                            teleportEl.setAttribute('hotspot-teleport', 
                                `targetCode: ${teleport.targetCode}; label: ${teleport.label}`
                            );
                            hotspotContainer.appendChild(teleportEl);
                        });
                        console.log(`Cargados ${property.teleports.length} hotspots de teletransporte.`);
                    }


                } else if (mediaType === 'gltf3d') {
                    // Carga para MODELO 3D (usa <a-gltf-model>)
                    modelContainer.setAttribute('visible', true);

                    const modelEntity = document.createElement('a-entity');
                    modelEntity.setAttribute('gltf-model', mediaUrl);
                    modelEntity.setAttribute('scale', '0.5 0.5 0.5');
                    modelEntity.setAttribute('position', '0 0.5 -2');
                    modelEntity.setAttribute('rotation', '0 0 0');
                    modelContainer.appendChild(modelEntity);

                    console.log(`Cargado modelo 3D GLTF: ${mediaUrl}`);

                } else {
                    throw new Error(`Tipo de medio desconocido: ${mediaType}`);
                }

            } catch (error) {
                propertyTitle.textContent = 'ERROR al cargar';
                propertyTitle.classList.remove('text-yellow-400', 'text-green-400', 'text-blue-400');
                propertyTitle.classList.add('text-red-400');
                propertyDescription.textContent = error.message;
                console.error("Error al cargar la propiedad:", error);
            }
        }


        // =====================================================================
        // LÓGICA DEL VISOR DE URL (NUEVO)
        // =====================================================================

        document.addEventListener('DOMContentLoaded', () => {
            
            // --- Funciones de la Modal de URL ---

            openUrlModalBtn.addEventListener('click', () => {
                urlInputModal.style.display = 'flex'; // Mostrar la modal
                urlInputModal.showModal(); // Usar showModal para un manejo correcto
                urlMessage.classList.add('hidden');
                urlInput.value = ''; // Limpiar el campo
            });

            closeUrlModalBtn.addEventListener('click', () => {
                urlInputModal.close(); // Cerrar la modal
                urlInputModal.style.display = 'none';
            });
            
            // Función para mostrar mensajes de error
            const showUrlMessage = (message, isError = true) => {
                urlMessage.textContent = message;
                urlMessage.classList.remove('hidden');
                urlMessage.classList.toggle('text-red-500', isError);
                urlMessage.classList.toggle('text-green-500', !isError);
            };

            // Manejo del formulario para cargar la URL
            urlForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const url = urlInput.value.trim();
                
                if (url) {
                    // Cargar la URL en el iframe
                    immersiveViewer.src = url;
                    loadedUrlDisplay.textContent = url;
                    
                    // Cerrar la modal de URL
                    urlInputModal.close();
                    urlInputModal.style.display = 'none';

                    // Abrir la modal del visor
                    contentModal.style.display = 'flex';
                    contentModal.showModal();

                } else {
                    showUrlMessage('Por favor, ingresa una URL válida.', true);
                }
            });

            // --- Funciones de la Modal de Contenido ---

            closeContentModalBtn.addEventListener('click', () => {
                contentModal.close();
                contentModal.style.display = 'none';
                // Limpiar el iframe al cerrar para detener la reproducción
                immersiveViewer.src = ""; 
            });
            
            // Permitir cerrar la modal de contenido al hacer clic fuera de ella (backdrop)
            contentModal.addEventListener('click', (event) => {
                if (event.target === contentModal) {
                    closeContentModalBtn.click();
                }
            });

            // Permitir cerrar la modal de URL al hacer clic fuera de ella (backdrop)
            urlInputModal.addEventListener('click', (event) => {
                if (event.target === urlInputModal) {
                    closeUrlModalBtn.click();
                }
            });

            // Inicia Firebase/A-Frame después de que el DOM esté listo
            initializeFirebase();
        });
    </script>

</body>
</html>
